name:  Semgrep ASVS Coverage for Python

on:
  workflow_dispatch:

jobs:
  asvs_python_scan: 
    runs-on: ubuntu-latest
    name:  Valida莽茫o Semgrep - Python (ASVS)

    steps:
      - name:  Clonar reposit贸rio
        uses: actions/checkout@v4

      - name: 锔 Instalar Semgrep
        run: |
          pipx install semgrep
      - name:  Instalar depend锚ncias (opcional)
        run: |
          pip install -r requirements.txt || echo " Nenhum requirements.txt encontrado ou erro ignorado."

      - name: И Executar Semgrep com regras correlacionadas ao ASVS
        continue-on-error: true
        run: |
          mkdir -p semgrep_output
          semgrep --config p/security-audit --config p/secrets --config p/python --output semgrep_output/results.sarif --sarif || echo " Semgrep falhou ou retornou findings."

      - name:  Gerar relat贸rio em Markdown com trechos (fallback incluso)
        run: |
          echo "#  Relat贸rio ASVS com Semgrep" > asvs_semgrep_report.md
          echo "" >> asvs_semgrep_report.md

          if [ -f semgrep-asvs.json ]; then
            jq -r '
             .results[] |
             "###  Regra: \(.check_id)\n" +
              "**Arquivo:** \(.path)\n" +
              "**Linha:** \(.start.line)\n\n" +
             "```python\n\(.extra.lines | join("\n"))\n```" +
              "\n---\n"
            ' semgrep-asvs.json >> asvs_semgrep_report.md
          else
            echo "锔 Arquivo semgrep-asvs.json n茫o encontrado. Sem resultados para exibir." >> asvs_semgrep_report.md
          fi
      - name:  Fazer upload dos artefatos
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-asvs-json
          path: semgrep_output/results.sarif

      - name:  Upload do relat贸rio Markdown
        uses: actions/upload-artifact@v4
        with:
          name: asvs-semgrep-report-md
          path: asvs_semgrep_report.md

      - name:  Exibir relat贸rio em tela
        run: |
          echo " Relat贸rio Detalhado com Trechos de C贸digo:"
          cat asvs_semgrep_report.md
