name: ğŸ” ASVS SAST Coverage with Semgrep + Trecho de CÃ³digo

on:
  workflow_dispatch:
    inputs:
      target_dir:
        description: "ğŸ“ DiretÃ³rio alvo (ex: ./src)"
        required: true
        default: "./"
        type: string

jobs:
  semgrep_asvs:
    name: "ğŸ§ª Semgrep + ASVS"
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Instalar Semgrep
        run: |
          python3 -m pip install --upgrade pip
          pip install semgrep

      - name: ğŸš¨ Rodar Semgrep com regras ASVS
        run: |
          semgrep --config p/owasp-asvs --config p/owasp --config p/r2c \
            --json --output semgrep_asvs_results.json "${{ inputs.target_dir }}" || true

      - name: ğŸ“Š Mostrar resultado detalhado
        run: |
          echo "ğŸ“‹ RelatÃ³rio Detalhado com Trechos de CÃ³digo:"
          echo ""

          total=$(jq '.results | length' semgrep_asvs_results.json)
          if [ "$total" -eq 0 ]; then
            echo "âŒ Nenhum requisito ASVS identificado."
            exit 0
          fi

          jq -r '
            .results[] |
            {
              check: .check_id,
              msg: .extra.message,
              file: .path,
              line: .start.line,
              code: .extra.lines
            } |
            "ğŸŸ© \(.check)\nğŸ“„ \(.file):\(.line)\nğŸ’¬ \(.msg)\n```\n\(.code)\n```"
          ' semgrep_asvs_results.json

      - name: ğŸ’¾ Salvar artefato JSON
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-asvs-json
          path: semgrep_asvs_results.json

      - name: ğŸ“¤ Gerar relatÃ³rio Markdown
        run: |
          echo "# ğŸ“‹ RelatÃ³rio ASVS com Semgrep" > asvs_semgrep_report.md
          echo "| Requisito ASVS | Caminho do Arquivo | Linha | Status | Mensagem | Trecho de CÃ³digo |" >> asvs_semgrep_report.md
          echo "|----------------|--------------------|-------|--------|----------|------------------|" >> asvs_semgrep_report.md

          jq -r '
            .results[] |
            {
              check: .check_id,
              msg: .extra.message,
              file: .path,
              line: .start.line,
              code: .extra.lines
            } |
            "| \(.check) | \(.file) | \(.line) | ğŸŸ© | \(.msg) | \(.code) |"
          ' semgrep_asvs_results.json >> asvs_semgrep_report.md

      - name: ğŸ“¤ Upload do relatÃ³rio Markdown
        uses: actions/upload-artifact@v4
        with:
          name: asvs-semgrep-report-md
          path: asvs_semgrep_report.md
